<!DOCTYPE html>
<html>
<head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <meta http-equiv="X-UA-Compatible" content="ie=edge">
     <title>Drone Flight Controller</title>
</head>
<body>
	
<link rel="stylesheet" href=/css/style.css>


<div class="wrapper">

<header>
  <h1><a href="/">Savo's Site</a></h1>
</header>

<nav>
<div class="flex-container">

<div class="navbutton"><a href="/about-me/">About Me</a></div>
<div class="dropdown">
	<a href="/projects/">Projects</a>
	<div class="dropdown-content">
		<a href="/projects/academic/">Academic</a>
		<a href="/projects/extracurricular/">Extracurricular</a>
		<a href="/projects/personal/">Personal</a>
		<a href="/projects/work/">Work</a>
	</div>
</div>
<div class="navbutton"><a href="/publications/">Publications</a></div>
<div class="navbutton"><a href="/work-experience/">Employment</a></div>
<div class="navbutton"><a href="/volunteering/">Volunteering</a></div>
<div class="navbutton"><a href="/contact/">Contact</a></div>

<div>
</nav>


<ul class="breadcrumbs">
    <li class="breadcrumbs"><a class="subtitle" href="/">Home</a></li>
                
                    
            		 	      <li class="breadcrumbs"><a class="subtitle" href="/projects">Projects</a></li>
            		    
				        
                
                    
            		 	      <li class="breadcrumbs"><a class="subtitle" href="/projects/personal">Personal Projects</a></li>
            		    
				        
                
                    
            		 	      <li class="breadcrumbs"><a class="subtitle" href="/projects/personal/flightcontrol">Drone Flight Controller</a></li>
            		    
				        </ul>



	
	<main>
	
	<h1 id="overview">Overview</h1>
<p>As part of my project to make a quadcopter from scratch I need a flight controller to control it in flight and receive
instructions from me. Overall this board would have four over responsibilities:</p>
<ol>
<li>Communicate with the ESCs for the motors</li>
<li>Read sensor data to determine that state of the drone</li>
<li>Receive commands from the controller</li>
<li>Apply control algorithms to adjust the drone&rsquo;s behaviour accordingly</li>
</ol>
<p>To achieve these, a microcontroller was put on a board as well as the basic sensors needed for a drone (accelerometer
and gyroscope) with breakouts to connect to the ESCs and the radio module.</p>
<p>There are two main revisions, the original ATmega328P based one, and a second STM32F103 based one.</p>
<p>I intend to write as much of the code related to the drone controls as I can, although I am prepared to revert to an
established open-source standard such as <a href="https://betaflight.com/">BetaFlight</a> and the like.</p>
<p>Although I have prepared the boards and done some basic tests, I plan to leave off most of the coding until I have
functioning ESCs to allow the drone to fly and better test control systems.</p>
<h2 id="requirements">Requirements</h2>
<ul>
<li>Communicate with the ESCs over I2C</li>
<li>Have a sensor to monitor linear and rotational accelerations</li>
<li>Have a way of receiving instruction wirelessly</li>
<li>Maintain the stability of the drone</li>
</ul>
<h2 id="objectives">Objectives</h2>
<ul>
<li>Monitor the altitude of the drone</li>
<li>Be able to send data back to the controller</li>
<li>Allow for additional features to be added later</li>
</ul>
<h2 id="takeaways">Takeaways</h2>
<p>Not too many so far really, other than the benefits of using a proper IDE for larger projects.</p>
<p>Will probably have more once I get coding them properly.</p>
<h1 id="detailed-report">Detailed Report</h1>
<p>The brain of a drone is generally called a flight controller and a drone is little more than four stupidly powerful motors
attached to a minuscule frame without one. This flight controller is responsible for not only receiving commands from the
pilot but also stabilizing the drone given feedback from sensors, namely Inertial Measurement Units (<strong>IMU</strong>) that keep
track of the accelerations the drone experiences and thus can be used to construct an idea of the drone&rsquo;s orientation and
speed.</p>
<p>Although there are commercial flight controllers available on the market I wanted to try my hand at making one from scratch
to see the effort that goes into it, as well as allowing myself to tailor it to my desires, most notably digital control
of the ESCs. I would also like to retain flexibility for future uses such as a fixed wing aircraft.</p>
<p>So far I have made two similar versions, save the microcontroller at the heart of them. I am primarily focusing my efforts
on developing the second one as it has the more capable microcontroller so I should be able to get more out of it in the
long run.</p>
<p>I intend to try and code them entirely, although I may likely make concessions to using publicly available libraries to
interface with the modules in the system so I may focus on the more application specific aspects of coding. I am also
aware of projects such as <a href="https://ardupilot.org/">ArduPilot</a> and <a href="https://betaflight.com/">BetaFlight</a> that I could try
to get working on my flight controller to simplify the development process if I find it too difficult.</p>
<h2 id="shared-electric-design">Shared Electric Design</h2>
<p>Although each revision is based around a different microcontroller, the majority of the systems around them are the same
across versions.</p>
<h3 id="power-supply">Power Supply</h3>
<p>Both boards have built in linear regulators to generate the voltages needed to run the microcontroller and the sensors on
board. They also both carry banks of decoupling capacitors for the regulator and most integrated circuits present.</p>
<h3 id="communication">Communication</h3>
<p>THe method of communication I intend to use on these boards is digital communication at 2.4GHz provided by standalone
nRF24L01 modules from Nordic Semiconductors. These house all the radio black magic on a separate board that is interacted
with over SPI from the main microcontroller. I gained familiarity with these from my telemetry work for HPVDT. In addition
to the SPI pins shared between the microcontroller and the module, there is a line used to flag the flight controller of a
received transmission which I have prepared to be used as an interrupt on the flight controller.</p>
<p>These modules I have purchased are rated for low bandwidth (~1 kb/s) at ranges of around 1km with direct line of sight.
This is good for me as I intend to operate this drone (for now) exclusively with direct line of sight and up to a few
hundred meters at most.</p>
<h3 id="sensors">Sensors</h3>
<p>There are two primary sensors ICs on each board use I2C to communicate with the microcontroller. They are the IMU and
barometer. This I2C bus needs to be operated at 3.3V since both chips operate at this level. Thi requires a level shifter
from the 5V I2C bus for the ESC to these.</p>
<h4 id="imu">IMU</h4>
<p>The boards use the same inertial measurement unit, an <a href="https://invensense.tdk.com/products/motion-tracking/6-axis/icm-20600/">ICM-20600</a>
which monitors six axes of motion: linear and rotational acceleration around the three Cartesian axes (X, Y, Z) relative
to the IC. They are capable of monitoring ±16g of acceleration and ±2000°/sec of rotation at their full scale, but this
can be decreased in exchange for improved accuracy in the measurements.</p>
<p>These will be used to help the drone deduce its current orientation based on the integrals of these readings.</p>
<h4 id="barometer">Barometer</h4>
<p>Each board has a barometer designed into it, the <a href="https://www.bosch-sensortec.com/products/environmental-sensors/pressure-sensors/bmp280/">BMP280</a>
which is used to monitor the ambient pressure and thus help estimate the altitude of the drone so it can maintain it.
It is accurate to under a meter and lower with the right algorithms so it will hopefully be helpful when navigated
closed spaces.</p>
<h3 id="extra-inputsoutputs">Extra Inputs/Outputs</h3>
<p>In the interest of keeping my design flexible for future use I have broken out many of the otherwise unused pins on my
microcontrollers to headers that I can easily connect to later. For example I could use these to control lights on my
drone(s) or actuators.</p>
<h3 id="programming-and-debugging">Programming and Debugging</h3>
<p>I left headers for the microcontrollers to be easily programmed using their designated protocols as well as the using
the standard Arduino-esque bootloader and USB to Serial adapter which is handy for sending detailed debugging data to
the controller even when not used for programming.</p>
<h1 id="versions">Versions</h1>
<p>Below is a list of my different versions of my flight boards. Their logs will contain the information specific to them
such as my motivation for making them as I did and the differing hardware.</p>

	
	
	
		

<div class="row">
<div class="column">




	<a href="https://savobajic.ca/projects/personal/flightcontrol/flightcontrol-v2/">
	<article>
	
	
	
		<img class="thumbnail" src="/images/flight-controller-v2-top-assembled.jpg">
	
	
	

<h2 class=listEntry>
	<a href="https://savobajic.ca/projects/personal/flightcontrol/flightcontrol-v2/">Flight Controller V2</a>
</h2>





	<p class="subtitle">Status: Development on hold for ESCs</p>
	
	
	<p class="subtitle">Started: May 2020</p>
	
	
	
	  <p class="subtitle"><strong>Tags:</strong> <a href="/tags/drone">drone</a> <a href="/tags/imu">imu</a> </p>
	









<p class="listEntry">My more powerful STM32 based version of a flight controller. <strong>Currently on hold.</strong></p>

	
	
	
		
	</article>
	</a>
	
	
  	</div> 
  	<div class="column">
	


	<a href="https://savobajic.ca/projects/personal/flightcontrol/flightcontrol-v1/">
	<article>
	
	
	
		<img class="thumbnail" src="/images/flight-controller-v1-top-assembled.jpg">
	
	
	

<h2 class=listEntry>
	<a href="https://savobajic.ca/projects/personal/flightcontrol/flightcontrol-v1/">Flight Controller V1</a>
</h2>





	<p class="subtitle">Status: Assembled. Not planning on using.</p>
	
	
	<p class="subtitle">Period: May 2020 - May 2020</p>
	
	
	
	  <p class="subtitle"><strong>Tags:</strong> <a href="/tags/drone">drone</a> <a href="/tags/imu">imu</a> </p>
	









<p class="listEntry">My first flight controller design. Based on an ATmega328P so I could adapt many open-source drone projects to it if needed.</p>

	
	
	
		
	</article>
	</a>
	
	
  	</div> 
  	<div class="column">
	

</div>
</div>

	
	</main>
	
	<footer>
     <a href="http://savobajic.ca/">Savo Bajic's Website</a>
</footer>
</div>

</body>
</html>
